<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>SARAL Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="icon" type="image/png" href="/static/assets/favicon.png">
    <style>
        /* --- CSS Variables & Reset --- */
        :root {
            --brand-blue: #4f8cff;
            --bg: #f5f2eb;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --muted: #64748b;
            --danger: #991b1b;
            --danger-bg: #fee2e2;
            --warn: #b45309;
            --warn-bg: #fef3c7;
            --ok: #166534;
            --ok-bg: #dcfce7;
        }

        * { box-sizing: border-box; }

        html, body {
            height: 100%; margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: radial-gradient(circle at top left, #ffffff 0, #f9fafb 30%, var(--bg) 70%), var(--bg);
            color: var(--text);
            display: flex; flex-direction: column;
        }

        /* --- Header --- */
        .topbar {
            flex: 0 0 auto; background: var(--bg); padding: 14px 24px 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06); display: flex; align-items: center;
            justify-content: space-between; box-shadow: 0 1px 4px rgba(15, 23, 42, 0.04);
        }
        .brand-left { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 34px; width: auto; display: block; }
        .brand-wrap { display: flex; flex-direction: column; }
        .brand-title { font-family: "Georgia", serif; font-size: 24px; font-weight: 700; color: var(--brand-blue); line-height: 1.1; }
        .brand-sub { font-size: 11px; text-transform: uppercase; letter-spacing: 0.16em; color: #6b7280; margin-top: 2px; }
        .pilot-tag { font-size: 12px; background: #e5e5e5; padding: 6px 12px; border-radius: 999px; color: #475569; font-weight: 700; }

        /* --- Main Layout --- */
        .main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        /* --- Landing --- */
        #landing { padding: 24px 20px; display: flex; flex-direction: column; justify-content: center; height: 100%; max-width: 680px; margin: 0 auto; width: 100%; }
        .hero-card { background: var(--surface); padding: 26px 22px 24px; border-radius: 22px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12); border: 1px solid var(--border); }
        .hero-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-size: 11px; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); background: linear-gradient(90deg, #e0f2fe, #ecfeff); margin-bottom: 10px; }
        .hero-badge-dot { width: 6px; height: 6px; border-radius: 999px; background: var(--brand-blue); }
        .hero-title { font-size: 24px; font-weight: 800; color: var(--text); margin-bottom: 8px; }
        .hero-sub { color: var(--muted); line-height: 1.6; margin-bottom: 22px; font-size: 14px; }
        .hero-divider { height: 1px; background: linear-gradient(to right, transparent, #e5e7eb, transparent); margin: 10px 0 14px; }
        .lang-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .lang-btn { padding: 11px 18px; border: 1.5px solid var(--border); border-radius: 999px; background: #f9fafb; font-weight: 700; color: #475569; cursor: pointer; transition: all 0.18s ease-out; min-width: 120px; }
        .lang-btn:hover { border-color: var(--brand-blue); box-shadow: 0 8px 18px rgba(37, 99, 235, 0.12); }

        /* --- Chat --- */
        #chatSection { display: flex; flex-direction: column; height: 100%; max-width: 640px; margin: 0 auto; width: 100%; background: var(--surface); border-left: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; }
        .chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .bubble { max-width: 84%; padding: 12px 16px; border-radius: 18px; font-size: 16px; line-height: 1.4; animation: slideUp 0.3s ease; word-wrap: break-word; white-space: pre-wrap; }
        .bot { align-self: flex-start; background: #f1f5f9; color: #1e293b; border-bottom-left-radius: 4px; }
        .user { align-self: flex-end; background: var(--brand-blue); color: #fff; border-bottom-right-radius: 4px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .input-area { flex: 0 0 auto; padding: 18px 20px 20px; border-top: 1px solid var(--border); background: var(--surface); }
        input, select { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; margin-bottom: 10px; background: #fff; }
        input:focus, select:focus { outline: none; border-color: var(--brand-blue); }
        .primary-btn { width: 100%; padding: 14px; background: var(--brand-blue); color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; }
        .helper { font-size: 12px; color: var(--muted); margin: -2px 0 10px; }
        .error { font-size: 13px; color: var(--danger); background: var(--danger-bg); border: 1px solid #fecaca; padding: 8px 10px; border-radius: 10px; margin: 0 0 10px; display: none; }
        .hidden { display: none !important; }

        /* --- RECEIPT OVERLAY --- */
        #result-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc; z-index: 999; flex-direction: column; align-items: center;
            justify-content: center; padding: 20px; text-align: center; animation: fadeIn 0.4s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .receipt-card {
            background: white; width: 100%; max-width: 380px; border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.1); overflow: hidden; border: 1px solid #e2e8f0;
        }
        .receipt-header { padding: 24px; border-bottom: 1px solid #e2e8f0; position: relative; }
        
        .receipt-logo { height: 32px; width: auto; margin-bottom: 16px; display: block; margin-left: auto; margin-right: auto; }
        
        .status-icon { font-size: 42px; margin-bottom: 8px; display: block; }
        .status-title { margin: 0; font-size: 22px; font-weight: 800; color: #0f172a; }
        .status-desc { margin: 8px 0 0; font-size: 15px; color: #64748b; line-height: 1.4; }
        
        .receipt-body { padding: 24px; background: #fafafa; }
        .hash-box {
            background: #e2e8f0; color: #334155; font-family: monospace; font-size: 20px;
            font-weight: 700; padding: 12px; border-radius: 8px; margin: 10px 0 20px;
            letter-spacing: 2px; border: 1px dashed #cbd5e1;
        }
        .receipt-footer {
            padding: 16px 24px; background: white; border-top: 1px solid #e2e8f0;
            font-size: 11px; color: #94a3b8; line-height: 1.5; text-align: left;
        }
        .btn-restart {
            margin-top: 30px; background: white; color: #0f172a; border: 1px solid #e2e8f0;
            padding: 12px 24px; border-radius: 99px; font-weight: 600; cursor: pointer; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="brand-left">
            <img src="/static/assets/saral.png" class="logo-img" alt="SARAL" onerror="this.style.display='none'">
            <div class="brand-wrap">
                <span class="brand-title">SARAL</span>
                <span class="brand-sub">ASSISTANT</span>
            </div>
        </div>
        <div class="pilot-tag">Field Pilot v1.3</div>
    </header>

    <div class="main-area">
        <section id="landing">
            <div class="hero-card">
                <div class="hero-badge"><span class="hero-badge-dot"></span>WELFARE ACCESS ¬∑ KIOSK TRIAGE</div>
                <div class="hero-title">Welcome / ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•á</div>
                <div class="hero-sub">Select the language you will use with the citizen. <strong>SARAL</strong> will ask basic eligibility questions.</div>
                <div class="hero-divider"></div>
                <div class="lang-row">
                    <button class="lang-btn" onclick="startSession('en')">English</button>
                    <button class="lang-btn" onclick="startSession('hi')">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                    <button class="lang-btn" onclick="startSession('mr')">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
                </div>
            </div>
        </section>

        <section id="chatSection" class="hidden">
            <div class="chat-container" id="chatBox"></div>
            <div class="input-area">
                <div id="inlineError" class="error"></div>
                <div id="inputWrapper"></div>
                <div id="nudgeBox" class="helper" style="display:none;"><span id="nudgeText"></span></div>
                <button id="nextBtn" class="primary-btn" onclick="handleNext()">Start</button>
            </div>
        </section>
    </div>

    <div id="result-screen">
        <div class="receipt-card">
            <div class="receipt-header" id="res-header">
                <img src="/static/assets/saral.png" class="receipt-logo" alt="SARAL" onerror="this.style.display='none'">
                
                <span class="status-icon" id="res-icon">‚úÖ</span>
                <h2 class="status-title" id="res-title">Processing...</h2>
                <p class="status-desc" id="res-desc">Securing data...</p>
            </div>
            <div class="receipt-body">
                <p style="margin:0 0 8px; font-size:12px; text-transform:uppercase; color:#64748b; font-weight:700;">Application ID</p>
                <div class="hash-box" id="res-hash">...</div>
                <p style="margin:0; font-size:13px; color:#64748b;">üì∑ <strong>Please take a photo of this screen.</strong></p>
            </div>
            <div class="receipt-footer">
                <strong>RESEARCH NOTICE:</strong> This is a preliminary screening based on submitted data. Final eligibility requires document verification and officer approval.
            </div>
        </div>
        <button class="btn-restart" onclick="window.location.reload()"> Start New Application </button>
    </div>

    <script>
        // --- STRINGS & FLOW ---
        const STRINGS = {
            en: {
                intro: "Namaste. Which scheme are we checking today?",
                mobile: "Citizen mobile number (10 digits)?",
                age: "Age (years)?",
                gender: "Gender?",
                income_period: "Income period?",
                income: "Household income (‚Çπ)?",
                edu: "Years of education?",
                loc: "Location?",
                caste: "Category?",
                verify: "Document Verification (Operator)?",
                verify_note: "Verification Notes?",
                notes: "Any notes (optional)?",
                start: "Next", next: "Next",
                nudge: "Enter exact amount. Thresholds are sensitive.",
                invalid: "Invalid value.",
                verify_opts: ["ID Verified (Physical)", "No ID Presented"]
            },
            hi: {
                intro: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á‡•§ ‡§Ü‡§ú ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§ú‡§æ‡§Å‡§ö‡§®‡•Ä ‡§π‡•à?",
                mobile: "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞ (10 ‡§Ö‡§Ç‡§ï)?",
                age: "‡§â‡§Æ‡•ç‡§∞ (‡§µ‡§∞‡•ç‡§∑)?",
                gender: "‡§≤‡§ø‡§Ç‡§ó?",
                income_period: "‡§Ü‡§Ø ‡§Ö‡§µ‡§ß‡§ø?",
                income: "‡§ò‡§∞‡•á‡§≤‡•Ç ‡§Ü‡§Ø (‚Çπ)?",
                edu: "‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ (‡§µ‡§∞‡•ç‡§∑)?",
                loc: "‡§∏‡•ç‡§•‡§æ‡§®?",
                caste: "‡§∂‡•ç‡§∞‡•á‡§£‡•Ä?",
                verify: "‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§®?",
                verify_note: "‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§®‡•ã‡§ü?",
                notes: "‡§®‡•ã‡§ü‡•ç‡§∏ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)?",
                start: "‡§Ü‡§ó‡•á", next: "‡§Ü‡§ó‡•á",
                nudge: "‡§∏‡§ü‡•Ä‡§ï ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§",
                invalid: "‡§ó‡§≤‡§§ ‡§Æ‡§æ‡§®‡•§",
                verify_opts: ["‡§™‡§π‡§ö‡§æ‡§® ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§", "‡§™‡§π‡§ö‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§à"]
            },
            mr: {
                intro: "‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞. ‡§Ü‡§ú ‡§ï‡•ã‡§£‡§§‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§§‡§™‡§æ‡§∏‡§æ‡§Ø‡§ö‡•Ä ‡§Ü‡§π‡•á?",
                mobile: "‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§®‡§Ç‡§¨‡§∞ (10 ‡§Ö‡§Ç‡§ï)?",
                age: "‡§µ‡§Ø (‡§µ‡§∞‡•ç‡§∑‡•á)?",
                gender: "‡§≤‡§ø‡§Ç‡§ó?",
                income_period: "‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä?",
                income: "‡§ò‡§∞‡§ó‡•Å‡§§‡•Ä ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® (‚Çπ)?",
                edu: "‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ (‡§µ‡§∞‡•ç‡§∑‡•á)?",
                loc: "‡§†‡§ø‡§ï‡§æ‡§£?",
                caste: "‡§µ‡§∞‡•ç‡§ó?",
                verify: "‡§ï‡§æ‡§ó‡§¶‡§™‡§§‡•ç‡§∞ ‡§™‡§°‡§§‡§æ‡§≥‡§£‡•Ä?",
                verify_note: "‡§™‡§°‡§§‡§æ‡§≥‡§£‡•Ä ‡§ü‡•Ä‡§™?",
                notes: "‡§ü‡§ø‡§™‡§æ (‡§ê‡§ö‡•ç‡§õ‡§ø‡§ï)?",
                start: "‡§™‡•Å‡§¢‡•á", next: "‡§™‡•Å‡§¢‡•á",
                nudge: "‡§Ö‡§ö‡•Ç‡§ï ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§≠‡§∞‡§æ.",
                invalid: "‡§ö‡•Å‡§ï‡•Ä‡§ö‡•á ‡§Æ‡•Ç‡§≤‡•ç‡§Ø.",
                verify_opts: ["‡§ì‡§≥‡§ñ ‡§™‡§°‡§§‡§æ‡§≥‡§≤‡•Ä", "‡§ì‡§≥‡§ñ ‡§®‡§æ‡§π‡•Ä"]
            }
        };

        let currentLang = "en";
        let currentStep = -1;
        let startTime = null;
        let formData = { profile: {} };

        const flow = [
            { key: "intro", type: "select", options: ["UJJ", "PMAY"], labels_en: ["PM Ujjwala", "PM Awas"], labels_hi: ["‡§™‡•Ä‡§è‡§Æ ‡§â‡§ú‡•ç‡§ú‡•ç‡§µ‡§≤‡§æ", "‡§™‡•Ä‡§è‡§Æ ‡§Ü‡§µ‡§æ‡§∏"], labels_mr: ["‡§™‡•Ä‡§è‡§Æ ‡§â‡§ú‡•ç‡§ú‡•ç‡§µ‡§≤‡§æ", "‡§™‡•Ä‡§è‡§Æ ‡§Ü‡§µ‡§æ‡§∏"], field: "scheme_code" },
            { key: "mobile", type: "tel", field: "citizen_hash", helper_en: "10 digits", helper_hi: "10 ‡§Ö‡§Ç‡§ï", helper_mr: "10 ‡§Ö‡§Ç‡§ï" },
            { key: "age", type: "number", field: "age", min: 0, max: 120 },
            { key: "gender", type: "select", options: ["F", "M", "O"], labels_en: ["Female", "Male", "Other"], labels_hi: ["‡§Æ‡§π‡§ø‡§≤‡§æ", "‡§™‡•Å‡§∞‡•Å‡§∑", "‡§Ö‡§®‡•ç‡§Ø"], labels_mr: ["‡§Æ‡§π‡§ø‡§≤‡§æ", "‡§™‡•Å‡§∞‡•Å‡§∑", "‡§á‡§§‡§∞"], field: "gender" },
            { key: "income_period", type: "select", options: ["monthly", "annual"], labels_en: ["Monthly", "Annual"], labels_hi: ["‡§Æ‡§æ‡§∏‡§ø‡§ï", "‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï"], labels_mr: ["‡§Æ‡§æ‡§∏‡§ø‡§ï", "‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï"], field: "income_period" },
            { key: "income", type: "number", field: "income", min: 0, nudge: true },
            { key: "edu", type: "number", field: "education_years", min: 0, max: 30 },
            { key: "loc", type: "select", options: ["1", "0"], labels_en: ["Rural", "Urban"], labels_hi: ["‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§∂‡§π‡§∞‡•Ä"], labels_mr: ["‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£", "‡§∂‡§π‡§∞‡•Ä"], field: "rural" },
            { key: "caste", type: "select", options: ["1", "0"], labels_en: ["Marginalized", "General"], labels_hi: ["‡§µ‡§Ç‡§ö‡§ø‡§§", "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø"], labels_mr: ["‡§µ‡§Ç‡§ö‡§ø‡§§", "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø"], field: "caste_marginalized" },
            { key: "verify", type: "select", options: ["ID_SEEN_PHYSICAL", "NO_ID_PRESENTED"], labels_en: ["Verified", "None"], field: "verification_status", isVerify: true },
            { key: "verify_note", type: "text", field: "verification_note", optional: true },
            { key: "notes", type: "text", field: "message_text", optional: true }
        ];

        // --- HELPER FUNCTIONS ---
        function showError(msg) {
            const box = document.getElementById("inlineError");
            box.innerText = msg || STRINGS[currentLang].invalid;
            box.style.display = "block";
        }
        function clearError() {
            const box = document.getElementById("inlineError");
            box.style.display = "none";
        }
        function isMobile10(raw) { return /^[0-9]{10}$/.test(String(raw).trim()); }
        function toIntStrict(raw) {
            const s = String(raw).trim();
            if (!/^\d+$/.test(s)) return null;
            return Number(s);
        }
        function to01Strict(raw) {
            const s = String(raw).trim();
            if (s === "0" || s === "1") return Number(s);
            return null;
        }
        function labelsFor(step) {
            if (currentLang === "hi") return step.labels_hi || step.labels_en;
            if (currentLang === "mr") return step.labels_mr || step.labels_en;
            return step.labels_en;
        }

        // --- CORE LOGIC ---
        function startSession(lang) {
            currentLang = lang;
            formData = { profile: {} };
            startTime = Date.now();
            currentStep = 0;
            
            document.getElementById("landing").classList.add("hidden");
            document.getElementById("chatSection").classList.remove("hidden");
            document.getElementById("chatBox").innerHTML = "";
            document.getElementById("nextBtn").innerText = STRINGS[lang].start;

            // Stable session ID
            let sess = Date.now().toString(36) + Math.random().toString(36).substr(2);
            formData.session_id = sess;

            addBubble(STRINGS[lang].intro, false);
            renderInput(flow[0]);
        }

        function addBubble(text, isUser) {
            const div = document.createElement("div");
            div.className = "bubble " + (isUser ? "user" : "bot");
            div.textContent = text;
            const box = document.getElementById("chatBox");
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function renderInput(step) {
            clearError();
            const wrapper = document.getElementById("inputWrapper");
            wrapper.innerHTML = "";
            
            // Nudge
            const nudgeBox = document.getElementById("nudgeBox");
            if (step.nudge) {
                nudgeBox.style.display = "block";
                document.getElementById("nudgeText").innerText = STRINGS[currentLang].nudge;
            } else {
                nudgeBox.style.display = "none";
            }

            if (step.type === "select") {
                const sel = document.createElement("select");
                sel.id = "currInput";
                
                let labs = labelsFor(step);
                if (step.isVerify) labs = STRINGS[currentLang].verify_opts;

                step.options.forEach((opt, idx) => {
                    const op = document.createElement("option");
                    op.value = opt;
                    op.innerText = (labs && labs[idx]) ? labs[idx] : opt;
                    sel.appendChild(op);
                });
                wrapper.appendChild(sel);
            } else {
                const inp = document.createElement("input");
                inp.id = "currInput";
                inp.type = step.type;
                if (step.field === "citizen_hash") {
                    inp.inputMode = "numeric";
                    inp.placeholder = "9876543210";
                }
                wrapper.appendChild(inp);
                inp.focus();
                inp.addEventListener("keydown", (e) => { if (e.key === "Enter") handleNext(); });
            }
        }

        async function handleNext() {
            clearError();
            const step = flow[currentStep];
            const el = document.getElementById("currInput");
            let val = (el && el.value != null) ? String(el.value).trim() : "";

            if (!val) {
                if (step.optional) val = "";
                else { showError(STRINGS[currentLang].invalid); return; }
            }

            // Validations
            let storedVal = val;
            if (step.field === "citizen_hash" && !isMobile10(val)) { showError("10 digits required"); return; }
            if (step.type === "number") {
                const n = toIntStrict(val);
                if (n === null) { showError(); return; }
                storedVal = n;
            }
            if (step.field === "age") {
            if (storedVal < 18) {
                showError("Minors cannot apply. Ask guardian / adult household member.");
                return;
            }
            }
            if (step.field === "rural" || step.field === "caste_marginalized") {
                const b = to01Strict(val);
                if (b === null) { showError(); return; }
                storedVal = b;
            }

            // Visual feedback
            let displayVal = val;
            if (step.type === "select") {
                const idx = step.options.indexOf(val);
                const labs = step.isVerify ? STRINGS[currentLang].verify_opts : labelsFor(step);
                if (idx > -1 && labs && labs[idx]) displayVal = labs[idx];
            }
            addBubble(displayVal || "‚Äî", true);

            // Store Data
            const profileFields = new Set(["age", "gender", "income_period", "income", "education_years", "rural", "caste_marginalized"]);
            if (profileFields.has(step.field)) formData.profile[step.field] = storedVal;
            else formData[step.field] = storedVal;

            currentStep++;
            if (currentStep >= flow.length) {
                submitForm();
                return;
            }

            const nextStep = flow[currentStep];
            const labelText = STRINGS[currentLang][nextStep.key] || nextStep.key;
            addBubble(labelText, false);
            renderInput(nextStep);
            document.getElementById("nextBtn").innerText = STRINGS[currentLang].next;
        }

        // --- SUBMIT & SHOW RECEIPT ---
        async function submitForm() {
            const wrapper = document.getElementById("inputWrapper");
            wrapper.innerHTML = "<em>Syncing...</em>";
            document.getElementById("nextBtn").style.display = "none";
            
            formData.source = "KIOSK_CHAT";
            formData.locale = currentLang;
            formData.meta_duration_seconds = Math.round((Date.now() - startTime) / 1000);

            try {
                const res = await fetch("/cases/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                });
                const data = await res.json().catch(() => ({}));
                
                if (res.ok) {
                    showResult(data);
                } else {
                    alert("Error: " + (data.detail || "Server Error"));
                    window.location.reload();
                }
            } catch (e) {
                alert("Network Error");
                window.location.reload();
            }
        }

        // --- RESULT LOGIC (RULE BASED) ---
        function showResult(data) {
            // Hide Chat UI
            document.getElementById("chatSection").style.display = "none";
            // Show Result UI
            const screen = document.getElementById("result-screen");
            screen.style.display = "flex";

            // Populate Hash
            document.getElementById("res-hash").innerText = (data.id || "ERROR").substring(0, 8).toUpperCase();

            // Populate Status based on RULES
            const title = document.getElementById('res-title');
            const desc = document.getElementById('res-desc');
            const icon = document.getElementById('res-icon');
            const header = document.getElementById('res-header');

            const rule = data.rule_result || "";

            if (rule === "ELIGIBLE_BY_RULE") {
                title.innerText = "Eligible to Apply";
                title.style.color = "#15803d";
                desc.innerText = "Profile meets basic criteria. Submitted for review.";
                icon.innerText = "‚úÖ";
                header.style.borderBottom = "4px solid #22c55e";
            } else if (rule === "INELIGIBLE_BY_RULE") {
                title.innerText = "Criteria Not Met";
                title.style.color = "#b91c1c";
                desc.innerText = "Income or Age requirements not met.";
                icon.innerText = "‚ö†Ô∏è";
                header.style.borderBottom = "4px solid #ef4444";
            } else {
                title.innerText = "Docs Verification";
                title.style.color = "#b45309";
                desc.innerText = "Submitted. Officer will check documents.";
                icon.innerText = "üìÇ";
                header.style.borderBottom = "4px solid #f59e0b";
            }
        }
    </script>
</body>
</html>